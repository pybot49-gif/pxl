import { createCanvas, type Canvas } from '../core/canvas.js';
import { setPixel } from '../core/draw.js';
import { isValidViewDirection, type ViewDirection } from './view.js';

/**
 * Valid build types for character bodies
 */
export type BuildType = 'skinny' | 'normal' | 'muscular';

/**
 * Valid height types for character bodies  
 */
export type HeightType = 'short' | 'average' | 'tall';

/**
 * Base body sprite with pixel data
 */
export interface BaseBodySprite extends Canvas {
  build: BuildType;
  heightType: HeightType;
}

/**
 * Placeholder colors for base body template
 */
const COLORS = {
  skin: { r: 255, g: 213, b: 160, a: 255 },     // #FFD5A0 - placeholder skin
  outline: { r: 80, g: 60, b: 40, a: 255 },     // #503C28 - dark outline
  shadow: { r: 230, g: 190, b: 140, a: 255 },   // #E6BE8C - skin shadow
} as const;

/**
 * Render a pixel map template to canvas using a color palette
 */
function renderPixelMap(canvas: Canvas, pixelMap: number[][], palette: Record<number, {r:number,g:number,b:number,a:number}>, startY: number = 0): void {
  for (let y = 0; y < pixelMap.length; y++) {
    const row = pixelMap[y];
    if (row === undefined) {
      continue;
    }
    for (let x = 0; x < row.length; x++) {
      const colorIndex = row[x];
      if (colorIndex === undefined || colorIndex === 0) {
        continue; // transparent or undefined
      }
      const color = palette[colorIndex];
      if (color !== undefined && startY + y < canvas.height) {
        setPixel(canvas.buffer, canvas.width, x, startY + y, color.r, color.g, color.b, color.a);
      }
    }
  }
}

/**
 * Chibi body template for front view (32x48 pixels)
 * Palette: 0=transparent, 1=outline, 2=skin, 3=shadow, 4=highlight
 */
const FRONT_BODY_MAP: number[][] = [
  // HEAD (rows 0-19) - Big chibi head
  // Row 0-3: Top of head
  [0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,1,2,2,2,2,2,2,2,2,2,2,2,2,1,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
  
  // Row 4-7: Upper head with more width
  [0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0],
  [0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0],
  
  // Row 8-11: Mid head with shadows
  [0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,2,2,1,0,0,0],
  [0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,2,2,1,0,0,0],
  [0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,2,2,1,0,0,0],
  [0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,2,2,1,0,0,0],
  
  // Row 12-15: Lower head with ears
  [0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,2,2,2,1,0,0],
  [0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,2,2,2,1,0,0],
  [0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,2,2,2,1,0,0],
  [0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,2,2,1,0,0,0],
  
  // Row 16-19: Chin area, narrowing
  [0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0],
  [0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,0,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,0,0,0,0,0,0],
  
  // NECK (rows 20-21)
  [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  
  // TORSO (rows 22-31)
  [0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0],
  [0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0],
  [0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0],
  [0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0],
  [0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0],
  [0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0],
  
  // LEGS (rows 32-43) - Two separate legs
  [0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0],
  
  // FEET (rows 44-47)
  [0,0,0,0,1,2,2,2,2,2,2,2,1,0,0,0,0,0,0,1,2,2,2,2,2,2,2,1,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,2,2,1,0,0,0,0,0,0,1,2,2,2,2,2,2,2,1,0,0,0,0],
  [0,0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
];

/**
 * Chibi body template for back view
 */
const BACK_BODY_MAP: number[][] = [
  // HEAD (rows 0-19) - Similar to front but no face details
  [0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,1,2,2,2,2,2,2,2,2,2,2,2,2,1,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0],
  [0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0],
  [0,0,1,2,2,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0],
  [0,0,1,2,2,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0],
  [0,0,1,2,2,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0],
  [0,0,1,2,2,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0],
  [0,1,2,2,2,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0],
  [0,1,2,2,2,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0],
  [0,1,2,2,2,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0],
  [0,0,1,2,2,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0],
  [0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0],
  [0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,0,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,0,0,0,0,0,0],
  // NECK
  [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  // TORSO
  [0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0],
  [0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0],
  [0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0],
  [0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0],
  [0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0],
  [0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0],
  // LEGS
  [0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,0,0,0],
  // FEET
  [0,0,0,0,1,2,2,2,2,2,2,2,1,0,0,0,0,0,0,1,2,2,2,2,2,2,2,1,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,2,2,1,0,0,0,0,0,0,1,2,2,2,2,2,2,2,1,0,0,0,0],
  [0,0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
];

/**
 * Chibi body template for left profile
 */
const LEFT_BODY_MAP: number[][] = [
  // HEAD - Profile shape (more oval)
  [0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,1,2,2,2,2,2,2,2,2,2,2,1,1,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,1,2,2,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,1,2,2,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,1,2,2,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [1,2,2,2,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [1,2,2,2,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [1,2,2,2,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
  [0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
  [0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,1,1,2,2,2,2,2,2,2,2,2,2,2,2,1,1,0,0,0,0,0,0,0,0,0,0,0,0],
  // NECK
  [0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  // TORSO - narrower profile
  [0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  // LEGS - closer together in profile
  [0,0,0,0,1,2,2,2,2,2,1,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,1,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,1,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,1,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,1,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,1,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,1,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,1,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,1,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,1,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,1,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,1,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0],
  // FEET
  [0,0,0,1,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,1,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
];

/**
 * Chibi body template for right profile (mirrored left)
 */
const RIGHT_BODY_MAP: number[][] = [
  // HEAD - Profile shape (mirrored)
  [0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,1,1,2,2,2,2,2,2,2,2,2,2,1,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,2,2,1,0,0,0,0],
  [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,2,2,1,0,0,0,0],
  [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,2,2,1,0,0,0,0],
  [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,2,2,2,1,0,0,0],
  [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,2,2,2,1,0,0,0],
  [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,2,2,2,1,0,0,0],
  [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,1,1,2,2,2,2,2,2,2,2,2,1,1,0,0,0,0,0,0,0,0,0],
  // NECK
  [0,0,0,0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0],
  // TORSO - narrower profile
  [0,0,0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0],
  // LEGS - closer together in profile
  [0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  // FEET
  [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,1,1,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
];

/**
 * Get the appropriate body pixel map for a view direction
 */
function getBodyPixelMap(direction: ViewDirection): number[][] {
  switch (direction) {
    case 'front':
      return FRONT_BODY_MAP;
    case 'back':
      return BACK_BODY_MAP;
    case 'left':
      return LEFT_BODY_MAP;
    case 'right':
      return RIGHT_BODY_MAP;
    case 'front-left':
      // Blend front and left by modifying front slightly
      return FRONT_BODY_MAP; // For now, using front as base
    case 'front-right':
      // Similar blend
      return FRONT_BODY_MAP;
    case 'back-left':
      return BACK_BODY_MAP;
    case 'back-right':
      return BACK_BODY_MAP;
    default:
      return FRONT_BODY_MAP;
  }
}

/**
 * Apply build and height modifications to base pixel map
 */
function applyBodyModifications(pixelMap: number[][], build: BuildType, height: HeightType): number[][] {
  // For now, return the base map. Future enhancement could stretch/scale the pixel maps
  // This would require more complex pixel interpolation
  void build; // Mark as used to avoid lint error
  void height; // Mark as used to avoid lint error
  return pixelMap;
}

/**
 * Create a base body template with pixel-perfect chibi art
 * @param build Body build type (skinny, normal, muscular)
 * @param height Body height type (short, average, tall)
 * @param direction View direction (defaults to 'front')
 * @returns BaseBodySprite with 32x48 chibi body
 */
export function createBaseBody(build: BuildType, height: HeightType, direction: ViewDirection = 'front'): BaseBodySprite {
  if (!isValidBuild(build)) {
    throw new Error(`Invalid build type: ${build}. Valid types: skinny, normal, muscular`);
  }
  
  if (!isValidHeight(height)) {
    throw new Error(`Invalid height type: ${height}. Valid types: short, average, tall`);
  }

  if (!isValidViewDirection(direction)) {
    throw new Error(`Invalid view direction: ${direction}. Valid directions: front, back, left, right, front-left, front-right, back-left, back-right`);
  }

  const canvas = createCanvas(32, 48);
  
  // Get the base pixel map for this direction
  let pixelMap = getBodyPixelMap(direction);
  
  // Apply build and height modifications
  pixelMap = applyBodyModifications(pixelMap, build, height);
  
  // Create color palette for rendering
  const palette = {
    0: { r: 0, g: 0, b: 0, a: 0 },           // transparent
    1: COLORS.outline,                        // dark outline
    2: COLORS.skin,                          // primary skin color  
    3: COLORS.shadow,                        // skin shadow
    4: { r: 255, g: 220, b: 177, a: 255 }   // skin highlight (lighter than primary)
  };
  
  // Render the pixel map to canvas
  renderPixelMap(canvas, pixelMap, palette);

  return {
    ...canvas,
    build,
    heightType: height,
  };
}

/**
 * Check if build type is valid
 */
function isValidBuild(build: string): build is BuildType {
  return ['skinny', 'normal', 'muscular'].includes(build);
}

/**
 * Check if height type is valid
 */
function isValidHeight(height: string): height is HeightType {
  return ['short', 'average', 'tall'].includes(height);
}

// Note: Build and height factor functions removed since pixel maps are not dynamically scaled yet.
// Future enhancement could add getBuildFactor() and getHeightFactor() for dynamic scaling.