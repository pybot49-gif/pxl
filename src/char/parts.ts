import { createCanvas, type Canvas } from '../core/canvas.js';
import { setPixel } from '../core/draw.js';
import { type ViewDirection } from './view.js';

/**
 * Valid part slots for character parts
 */
export type PartSlot = 
  | 'hair-back' | 'hair-front' 
  | 'eyes' | 'nose' | 'mouth' | 'ears'
  | 'torso' | 'arms-left' | 'arms-right'
  | 'legs' | 'feet-left' | 'feet-right';

/**
 * Valid hair styles
 */
export type HairStyle = 'spiky' | 'long' | 'curly';

/**
 * Valid eye styles  
 */
export type EyeStyle = 'round' | 'anime' | 'small';

/**
 * Valid torso styles
 */
export type TorsoStyle = 'basic-shirt' | 'armor' | 'robe';

/**
 * Color region coordinates for recoloring
 */
export type ColorRegion = [number, number][]; // Array of [x, y] coordinates

/**
 * Character part with pixel data and metadata
 */
export interface CharacterPart extends Canvas {
  id: string;
  slot: PartSlot;
  colorable: boolean;
  colorRegions: {
    primary: ColorRegion;
    shadow: ColorRegion;
    highlight?: ColorRegion;
  };
  compatibleBodies: string[];
}

/**
 * Placeholder colors for character parts
 */
const COLORS = {
  // Hair colors
  hair: { r: 101, g: 67, b: 33, a: 255 },        // #654321 - brown hair
  hairShadow: { r: 80, g: 52, b: 25, a: 255 },   // #503419 - darker brown

  // Eye colors
  eyeWhite: { r: 250, g: 250, b: 250, a: 255 },  // #FAFAFA - eye white
  eyeIris: { r: 74, g: 122, b: 188, a: 255 },    // #4A7ABC - blue iris
  eyePupil: { r: 26, g: 26, b: 42, a: 255 },     // #1A1A2A - dark pupil

  // Clothing colors
  shirt: { r: 204, g: 51, b: 51, a: 255 },       // #CC3333 - red shirt
  shirtShadow: { r: 170, g: 40, b: 40, a: 255 }, // #AA2828 - darker red
  armor: { r: 160, g: 160, b: 160, a: 255 },     // #A0A0A0 - gray armor
  armorShadow: { r: 120, g: 120, b: 120, a: 255 }, // #787878 - darker gray

  // Outline
  outline: { r: 42, g: 42, b: 42, a: 255 },      // #2A2A2A - dark outline
} as const;

/**
 * Render a pixel map template to canvas and collect color regions
 */
function renderPixelMapWithRegions(
  canvas: Canvas, 
  pixelMap: number[][], 
  palette: Record<number, {r:number,g:number,b:number,a:number}>,
  colorRegions: { primary: [number, number][]; shadow: [number, number][]; highlight?: [number, number][] },
  primaryIndices: number[],
  shadowIndices: number[],
  highlightIndices?: number[]
): void {
  for (let y = 0; y < pixelMap.length && y < canvas.height; y++) {
    const row = pixelMap[y];
    if (row === undefined) {
      continue;
    }
    for (let x = 0; x < row.length && x < canvas.width; x++) {
      const colorIndex = row[x];
      if (colorIndex === undefined || colorIndex === 0) {
        continue; // transparent or undefined
      }
      
      const color = palette[colorIndex];
      if (color !== undefined) {
        setPixel(canvas.buffer, canvas.width, x, y, color.r, color.g, color.b, color.a);
        
        // Categorize pixel for color regions
        if (primaryIndices.includes(colorIndex)) {
          colorRegions.primary.push([x, y]);
        } else if (shadowIndices.includes(colorIndex)) {
          colorRegions.shadow.push([x, y]);
        } else if (highlightIndices?.includes(colorIndex) === true) {
          colorRegions.highlight ??= [];
          colorRegions.highlight.push([x, y]);
        }
      }
    }
  }
}

// ==================== HAIR TEMPLATES ====================

/**
 * Spiky hair pixel maps for front view (48x64)
 * Palette: 0=transparent, 1=outline, 2=hair primary, 3=hair shadow, 4=hair highlight
 */
const SPIKY_HAIR_FRONT: number[][] = [
  // Top spikes (rows 0-12) - tall pointed spikes extending ~8-10px above head
  [0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,1,1,1,0,0,0,1,1,1,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,1,2,2,2,1,0,1,2,2,2,1,0,1,2,2,2,1,0,1,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,2,2,2,2,2,1,2,2,2,2,2,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
  [0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
  [0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0],
  [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0],
  [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0],
  
  // Mid hair with shadows and volume (rows 13-20)
  [1,2,2,2,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,2,2,2,2,1,0,0,0,0,0],
  [1,2,2,3,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,2,2,2,1,0,0,0,0,0],
  [1,2,2,3,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,2,2,2,1,0,0,0,0,0],
  [1,2,2,3,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,2,2,2,1,0,0,0,0,0],
  [1,2,2,3,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,2,2,2,1,0,0,0,0,0],
  [1,2,2,2,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,2,2,2,2,1,0,0,0,0,0],
  [1,2,2,2,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,2,2,2,2,1,0,0,0,0,0],
  [0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0],
  
  // Lower hair extending to cover sides of head (rows 21-30)
  [0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0],
  [0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
  [0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
  [0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0],
  
  // Fill rest with empty rows
  ...Array(33).fill(new Array(48).fill(0))
];

/**
 * Long hair pixel maps for front view (48x64) - flowing hair reaching row 40+
 */
const LONG_HAIR_FRONT: number[][] = [
  // Top of hair (rows 0-8) - full width coverage
  [0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,1,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,1,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0],
  [0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0],
  
  // Mid hair (rows 9-20) - covering head area
  [0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0],
  [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0],
  [1,2,2,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,2,2,2,1,0],
  [1,2,2,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,2,2,2,1,0],
  [1,2,2,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,2,2,2,1,0],
  [1,2,2,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,2,2,2,1,0],
  [1,2,2,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,2,2,2,1,0],
  [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0],
  [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0],
  [0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0],
  [0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0],
  [0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0],
  
  // Long flowing sections (rows 21-45) - hair flowing down past shoulders
  [0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0],
  [0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0],
  [0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0],
  [0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  
  // Fill rest with empty rows
  ...Array(19).fill(new Array(48).fill(0))
];

/**
 * Curly hair pixel maps for front view (48x64) - round voluminous curls
 */
const CURLY_HAIR_FRONT: number[][] = [
  // Top curls (rows 0-10) - bouncy curl pattern
  [0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,1,1,1,1,1,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,1,2,2,2,2,2,1,0,1,2,2,2,2,2,1,0,1,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,1,2,2,2,2,2,2,2,1,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0,0],
  [0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
  [0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
  
  // Curly volume with shadow details (rows 11-25)
  [1,2,2,2,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,2,2,2,1,0,0,0,0,0,0],
  [1,2,3,3,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,2,1,0,0,0,0,0,0],
  [1,2,3,3,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,2,1,0,0,0,0,0,0],
  [1,2,3,3,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,2,1,0,0,0,0,0,0],
  [1,2,3,3,3,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,3,3,3,2,1,0,0,0,0,0,0],
  [1,2,2,3,3,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,3,3,2,2,1,0,0,0,0,0,0],
  [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0],
  [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0],
  [1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0],
  [0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
  [0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0],
  [0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0],
  [0,0,0,1,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,2,1,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0],
  
  // Fill rest with empty rows
  ...Array(39).fill(new Array(48).fill(0))
];

// ==================== EYE TEMPLATES ====================

/**
 * Round eyes pixel maps (48x64) - 5x4 pixel eyes with highlights
 * Positioned at face area (rows 18-24, columns 14-34)
 */
const ROUND_EYES: number[][] = [
  ...Array(18).fill(new Array(48).fill(0)),
  // Row 18: Start of eyes
  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,1,5,5,5,5,5,1,0,0,0,0,0,0,0,1,5,5,5,5,5,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,1,5,5,6,6,5,1,0,0,0,0,0,0,0,1,5,5,6,6,5,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,1,5,6,7,7,6,1,0,0,0,0,0,0,0,1,5,6,7,7,6,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,1,5,6,7,8,6,1,0,0,0,0,0,0,0,1,5,6,7,8,6,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  // Fill rest with empty rows
  ...Array(40).fill(new Array(48).fill(0))
];

/**
 * Anime eyes pixel maps (48x64) - 6x5 larger eyes with multiple highlights
 */
const ANIME_EYES: number[][] = [
  ...Array(17).fill(new Array(48).fill(0)),
  // Row 17: Start of larger anime eyes
  [0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,1,5,5,5,5,5,5,1,0,0,0,0,0,0,1,5,5,5,5,5,5,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,1,5,5,6,6,6,5,1,0,0,0,0,0,0,1,5,5,6,6,6,5,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,1,5,6,7,7,7,6,1,0,0,0,0,0,0,1,5,6,7,7,7,6,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,1,5,6,7,7,7,6,1,0,0,0,0,0,0,1,5,6,7,7,7,6,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,1,5,6,8,7,8,6,1,0,0,0,0,0,0,1,5,6,8,7,8,6,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  // Fill rest with empty rows
  ...Array(40).fill(new Array(48).fill(0))
];

/**
 * Small eyes pixel maps (48x64) - 3x2 narrow squinty eyes
 */
const SMALL_EYES: number[][] = [
  ...Array(19).fill(new Array(48).fill(0)),
  // Row 19: Small squinty eyes
  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,7,1,0,0,0,0,0,0,0,0,0,0,0,1,7,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  // Fill rest with empty rows
  ...Array(42).fill(new Array(48).fill(0))
];

// ==================== TORSO TEMPLATES ====================

/**
 * Basic shirt pixel maps (48x64) - T-shirt covering rows 37-50
 */
const BASIC_SHIRT: number[][] = [
  ...Array(37).fill(new Array(48).fill(0)),
  // Shirt starts at row 37 - collar and shoulders
  [0,0,0,0,0,0,0,0,0,0,0,0,1,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,1,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,1,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,1,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,1,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,1,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,1,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,1,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,1,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,1,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,1,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,1,9,9,10,10,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,10,10,9,9,9,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,1,9,9,10,10,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,10,10,9,9,9,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,9,10,10,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,10,10,9,1,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,1,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,1,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,1,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,1,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,1,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,9,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  // Fill rest with empty rows
  ...Array(13).fill(new Array(48).fill(0))
];

/**
 * Armor pixel maps (48x64) - plate armor with shoulder pads
 */
const ARMOR: number[][] = [
  ...Array(37).fill(new Array(48).fill(0)),
  // Armor starts at row 37 - shoulder pads and chest plate
  [0,0,0,0,0,0,0,0,0,0,0,0,1,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,1,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,1,11,12,12,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,12,12,11,11,1,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,1,11,12,12,12,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,12,12,12,11,11,1,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,1,11,12,12,12,12,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,12,12,12,12,11,11,1,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,11,12,12,12,12,12,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,12,12,12,12,12,11,11,1,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,11,12,12,12,12,12,12,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,12,12,12,12,12,12,11,11,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,1,11,12,12,12,12,12,12,12,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,12,12,12,12,12,12,12,11,11,1,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,1,11,12,12,12,12,12,12,12,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,12,12,12,12,12,12,12,11,11,1,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,1,11,12,12,12,12,12,12,12,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,12,12,12,12,12,12,12,11,11,1,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,11,12,12,12,12,12,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,12,12,12,12,12,11,11,1,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,11,11,12,12,12,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,12,12,12,11,11,11,1,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,1,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,1,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,1,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,1,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,11,1,0,0,0,0,0,0,0,0,0,0,0,0],
  // Fill rest with empty rows
  ...Array(13).fill(new Array(48).fill(0))
];

/**
 * Robe pixel maps (48x64) - flowing robe reaching to row 55+
 */
const ROBE: number[][] = [
  ...Array(37).fill(new Array(48).fill(0)),
  // Robe starts at row 37 - wide flowing garment
  [0,0,0,0,0,0,0,0,0,0,0,0,1,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,1,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,1,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,1,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,1,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,1,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,1,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,1,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,1,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,1,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,1,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,1,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,1,13,13,14,14,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,14,14,13,13,13,13,1,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,1,13,13,14,14,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,14,14,13,13,13,13,1,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,13,14,14,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,14,14,13,13,13,1,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,1,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,1,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,1,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,1,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,1,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,1,0,0,0,0,0,0,0,0,0,0,0],
  
  // Continuing robe down to row 55+ (longer than shirt/armor)
  [0,0,0,0,0,0,0,0,0,1,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,1,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,1,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,1,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,1,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,1,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,1,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,1,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,1,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,1,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,13,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  [0,0,0,0,0,0,0,0,0,0,0,0,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,1,0,0,0,0,0,0,0,0,0,0,0,0,0,0,0],
  
  // Fill rest with empty rows
  ...Array(7).fill(new Array(48).fill(0))
];

/**
 * Create a character part with pixel art and color regions
 * @param id Part identifier
 * @param slot Part slot
 * @param pixelMap Pixel data array
 * @param colorIndices Configuration for color region mapping
 * @returns CharacterPart with 48x64 canvas
 */
function createCharacterPart(
  id: string,
  slot: PartSlot,
  pixelMap: number[][],
  colorIndices: {
    primary: number[];
    shadow: number[];
    highlight?: number[];
  }
): CharacterPart {
  const canvas = createCanvas(48, 64);
  
  const colorRegions = {
    primary: [] as [number, number][],
    shadow: [] as [number, number][],
    highlight: [] as [number, number][]
  };

  // Create color palette based on part type
  let palette: Record<number, {r:number,g:number,b:number,a:number}>;
  
  if (slot.startsWith('hair')) {
    palette = {
      0: { r: 0, g: 0, b: 0, a: 0 },
      1: COLORS.outline,
      2: COLORS.hair,
      3: COLORS.hairShadow,
      4: { r: 130, g: 85, b: 45, a: 255 } // hair highlight
    };
  } else if (slot === 'eyes') {
    palette = {
      0: { r: 0, g: 0, b: 0, a: 0 },
      1: COLORS.outline,
      5: COLORS.eyeWhite,
      6: COLORS.eyeIris,
      7: COLORS.eyePupil,
      8: { r: 255, g: 255, b: 255, a: 255 } // highlight
    };
  } else if (slot === 'torso') {
    palette = {
      0: { r: 0, g: 0, b: 0, a: 0 },
      1: COLORS.outline,
      9: COLORS.shirt,
      10: COLORS.shirtShadow,
      11: COLORS.armor,
      12: COLORS.armorShadow,
      13: { r: 128, g: 0, b: 128, a: 255 }, // robe primary
      14: { r: 100, g: 0, b: 100, a: 255 }  // robe shadow
    };
  } else {
    // Default palette
    palette = {
      0: { r: 0, g: 0, b: 0, a: 0 },
      1: COLORS.outline,
      2: COLORS.hair,
      3: COLORS.hairShadow
    };
  }

  renderPixelMapWithRegions(
    canvas,
    pixelMap,
    palette,
    colorRegions,
    colorIndices.primary,
    colorIndices.shadow,
    colorIndices.highlight
  );

  return {
    ...canvas,
    id,
    slot,
    colorable: true,
    colorRegions,
    compatibleBodies: ['chibi']
  };
}

/**
 * Create spiky hair part
 */
export function createSpikyHair(direction: ViewDirection = 'front'): CharacterPart {
  // For now, only front view implemented
  void direction;
  return createCharacterPart('hair-spiky', 'hair-front', SPIKY_HAIR_FRONT, {
    primary: [2],
    shadow: [3],
    highlight: [4]
  });
}

/**
 * Create long hair part
 */
export function createLongHair(direction: ViewDirection = 'front'): CharacterPart {
  void direction;
  return createCharacterPart('hair-long', 'hair-front', LONG_HAIR_FRONT, {
    primary: [2],
    shadow: [3],
    highlight: [4]
  });
}

/**
 * Create curly hair part
 */
export function createCurlyHair(direction: ViewDirection = 'front'): CharacterPart {
  void direction;
  return createCharacterPart('hair-curly', 'hair-front', CURLY_HAIR_FRONT, {
    primary: [2],
    shadow: [3],
    highlight: [4]
  });
}

/**
 * Create round eyes part
 */
export function createRoundEyes(direction: ViewDirection = 'front'): CharacterPart {
  void direction;
  return createCharacterPart('eyes-round', 'eyes', ROUND_EYES, {
    primary: [5], // eye white
    shadow: [6], // iris
    highlight: [8] // specular highlight
  });
}

/**
 * Create anime eyes part
 */
export function createAnimeEyes(direction: ViewDirection = 'front'): CharacterPart {
  void direction;
  return createCharacterPart('eyes-anime', 'eyes', ANIME_EYES, {
    primary: [5], // eye white
    shadow: [6], // iris
    highlight: [8] // specular highlight
  });
}

/**
 * Create small eyes part
 */
export function createSmallEyes(direction: ViewDirection = 'front'): CharacterPart {
  void direction;
  return createCharacterPart('eyes-small', 'eyes', SMALL_EYES, {
    primary: [7], // pupil only for small eyes
    shadow: [],
    highlight: []
  });
}

/**
 * Create basic shirt part
 */
export function createBasicShirt(direction: ViewDirection = 'front'): CharacterPart {
  void direction;
  return createCharacterPart('torso-basic-shirt', 'torso', BASIC_SHIRT, {
    primary: [9],
    shadow: [10],
    highlight: []
  });
}

/**
 * Create armor part
 */
export function createArmor(direction: ViewDirection = 'front'): CharacterPart {
  void direction;
  return createCharacterPart('torso-armor', 'torso', ARMOR, {
    primary: [11],
    shadow: [12],
    highlight: []
  });
}

/**
 * Create robe part
 */
export function createRobe(direction: ViewDirection = 'front'): CharacterPart {
  void direction;
  return createCharacterPart('torso-robe', 'torso', ROBE, {
    primary: [13],
    shadow: [14],
    highlight: []
  });
}

/**
 * Create a character part by style
 * @param slot Part slot
 * @param style Style identifier
 * @param direction View direction
 * @returns CharacterPart
 */
export function createCharacterPartByStyle(slot: PartSlot, style: string, direction: ViewDirection = 'front'): CharacterPart {
  switch (slot) {
    case 'hair-front':
      switch (style) {
        case 'spiky': return createSpikyHair(direction);
        case 'long': return createLongHair(direction);
        case 'curly': return createCurlyHair(direction);
        default: return createSpikyHair(direction);
      }
    case 'eyes':
      switch (style) {
        case 'round': return createRoundEyes(direction);
        case 'anime': return createAnimeEyes(direction);
        case 'small': return createSmallEyes(direction);
        default: return createRoundEyes(direction);
      }
    case 'torso':
      switch (style) {
        case 'basic-shirt': return createBasicShirt(direction);
        case 'armor': return createArmor(direction);
        case 'robe': return createRobe(direction);
        default: return createBasicShirt(direction);
      }
    default:
      throw new Error(`Unsupported part slot: ${slot}`);
  }
}

/**
 * Get available styles for a part slot
 */
export function getPartStyles(slot: PartSlot): string[] {
  switch (slot) {
    case 'hair-front':
    case 'hair-back':
      return ['spiky', 'long', 'curly'];
    case 'eyes':
      return ['round', 'anime', 'small'];
    case 'torso':
      return ['basic-shirt', 'armor', 'robe'];
    default:
      return [];
  }
}

/**
 * Check if a part style is valid for the given slot
 */
export function isValidPartStyle(slot: PartSlot, style: string): boolean {
  return getPartStyles(slot).includes(style);
}

// ==================== WRAPPER FUNCTIONS FOR TESTS ====================

/**
 * Create hair part by style (for test compatibility)
 */
export function createHairPart(style: string, direction: ViewDirection = 'front'): CharacterPart {
  if (!['spiky', 'long', 'curly'].includes(style)) {
    throw new Error(`Invalid hair style: ${style}`);
  }
  return createCharacterPartByStyle('hair-front', style, direction);
}

/**
 * Create eye part by style (for test compatibility)
 */
export function createEyePart(style: string, direction: ViewDirection = 'front'): CharacterPart {
  if (!['round', 'anime', 'small'].includes(style)) {
    throw new Error(`Invalid eye style: ${style}`);
  }
  return createCharacterPartByStyle('eyes', style, direction);
}

/**
 * Create torso part by style (for test compatibility)
 */
export function createTorsoPart(style: string, direction: ViewDirection = 'front'): CharacterPart {
  if (!['basic-shirt', 'armor', 'robe'].includes(style)) {
    throw new Error(`Invalid torso style: ${style}`);
  }
  return createCharacterPartByStyle('torso', style, direction);
}